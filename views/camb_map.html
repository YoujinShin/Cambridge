<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Cambridge</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.2/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.2/mapbox.css' rel='stylesheet' />

<script src="http://d3js.org/d3.v3.min.js"></script> 
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>

<!-- <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" /> -->
<!-- <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script> -->

<style>
  body { margin:0; padding:0; font-family: sans-serif; }
  #map { position:absolute; top:0; bottom:0; width:100%; background-color:rgba(0,0,0,1); }

.menu-ui {
  background:#fff;
  position:absolute;
  top:10px;right:10px;
  z-index:1;
  border-radius:0px;
  width:120px;
  border:1px solid rgba(0,0,0,0.1);
  }
  .menu-ui a {
    font-size:11px;
    letter-spacing: 1px;
    color: #000;
    display:block;
    margin:0;padding:0;
    padding:10px;
    text-decoration:none;
    border-bottom:1px solid rgba(0,0,0,0.25);
    text-align:center;
    }
    .menu-ui a:first-child {
      border-radius:0px 0px 0 0;
      }
    .menu-ui a:last-child {
      border:none;
      border-radius:0 0 0px 0px;
      }
    .menu-ui a:hover {
      background:#f8f8f8;
      /*color:#404040;*/
      }
    .menu-ui a.active {
      background:#000;
      color:#FFF;
      }
      .menu-ui a.active:hover {
        background:#000;
        }

.map-legend .swatch {
  width:20px;
  height:20px;
  float:left;
  margin-right:10px;
  }
.leaflet-popup-close-button {
  display: none;
  }
.leaflet-popup-content-wrapper {
  pointer-events: none;
  }

  .des_age {
  		visibility: hidden;
		position: absolute;
		top: 80px;
		left: 120px;
		width: 300px;
		z-index: 14 !important;
	}
	.side_left {
		position: absolute;
		left: 80px;
		top: 0px;
		width: 150px;
		height: 100%;
		/*background-color: rgba(0, 0, 0, 0.2);*/
		background-color: rgba(255, 255,255,0.8);
		z-index: 5 !important;
		visibility: hidden;
	}
	.side_right {
		position: absolute;
		left: 230px;
		top: 0px;
		width: 150px;
		height: 100%;
		/*background-color: rgba(0, 0, 0, 0.2);*/
		background-color: rgba(255, 255,255,0.8);
		z-index: 5 !important;
		visibility: hidden;
	}

	/*population by age bar graph*/
    .bar.positive {
	  fill: #60b260;
	}

	.bar.negative {
	  fill: #f4b925;
	}
	.axis text {
	  font: 10px sans-serif;
	}

	.axis path,
	.axis line {
	  fill: none;
	  stroke: #000;
	  shape-rendering: crispEdges;
	}

	.highlight {
		position: absolute;
		fill: rgba(0,0,0,0.3);
		z-index: 20 !important;
	}
</style>
</head>



<body>

<nav id='menu-ui' class='menu-ui'></nav>
<div class="side_left" id="viz_left"></div>
<div class="side_right" id="viz_right"></div>
<div id='map'></div>


<script src="pop_age.js" type="text/javascript"></script>
<script>
L.mapbox.accessToken = 'pk.eyJ1IjoibWVnZ29uYWd1bCIsImEiOiI1cFpUOE5RIn0.jooCCIM584kmRt2nkSOcHw';


var map = L.map('map').setView([42.3783903,-71.1129096-0.025], 13);
var layers = document.getElementById('menu-ui');
var base_layer = L.mapbox.tileLayer('examples.map-20v6611k');
// var zoning = L.mapbox.featureLayer().loadURL('CDD_ZoningDistricts.geojson');
var total_population;
var zoning;
var sewer;

var popup = new L.Popup({ autoPan: false });


// total populcation data mapping
var rateById = d3.map();
var popAcrebyID = d3.map(); // population per acre
var housingAcrebyID = d3.map(); // housing units per acre


// age population data
var under_18 = d3.map();
var over_65 = d3.map()


queue() // upload data using queue 
	.defer(d3.json, "tracts_2010.geojson")
	.defer(d3.json, "CDD_ZoningDistricts.geojson")
	// .defer(d3.json, "Sewers_with_Load_and_Her.json")
	.defer(d3.csv, "camb_tract_pop_2010.csv", function(d) { 
		rateById.set(d.id, +d.population);
		popAcrebyID.set(d.id, + d.population_per_acre);
		housingAcrebyID.set(d.id, + d.housing_units_per_acre);
	})
	.await(ready);


function addLayer(layer, name, zIndex) {
    layer
        .setZIndex(zIndex);

    var link = document.createElement('a');
        link.href = '#';
        link.className = '';
        link.innerHTML = name;

    if(layer == base_layer) {
    	layer.addTo(map);
    	link.className = 'active';
    }

    link.onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (map.hasLayer(layer)) {
            map.removeLayer(layer);
            this.className = '';

            if(layer == total_population) {
            	hideAge();
            }
        } else {
            map.addLayer(layer);
            this.className = 'active';
            if(layer == total_population) {
            	addAge();
            }
        }
    };

    layers.appendChild(link);
}


// // add layers
function ready(error, tract, district, sewer) {
	console.log("data uploaded");

	total_population = L.geoJson(tract,  {
		style: getStyle,
	    onEachFeature: onEachFeature
	});

	zoning = L.geoJson(district, {
		style: getZoneStyle
	});

	// sewer = L.geoJson(sewer, {
	// 	style: getSewerStyle
	// });

	addLayer(base_layer, 'Base Map', 1);  // grey
	addLayer(total_population, 'Total population', 2);
	addLayer(zoning, 'Zoning districts', 3);

	// $( "#viz_left" ).css( "visibility", "hidden" );
	// $( "#viz_right" ).css( "visibility", "hidden" );
	// $( "#des_age" ).css( "visibility", "hidden" );	
	// addLayer(sewer, 'Sewer network', 4);
}

function getSewerStyle(feature) {
	return {
		weight: 1,
		color: 'red'
	};
}

// style for districts
function getZoneStyle(feature) {
	// console.log(feature);
	return {
		weight: 1,
		color: 'rgb(0,0,255)'
	};
}

// style for total population
function getStyle(feature) {
	var id = feature.properties.NAME10;
	var c = getColor( rateById.get(id) );

	return {
		weight: 1,
		opacity: 0.8,
		color: 'white',
		fillOpacity: 0.7,
		fillColor: c
	};
}

function getColor(d) {
	if (d >= 0 && d < 1000) { return 'rgb(222,235,247)'; }
	else if (d >= 1000 && d < 2000) { return "rgb(198,219,239)"; }
	else if (d >= 2000 && d < 3000) { return "rgb(158,202,225)"; }
	else if (d >= 3000 && d < 4000) { return "rgb(107,174,214)"; }
	else if (d >= 4000 && d < 5000) { return "rgb(66,146,198)"; }
	else if (d >= 5000 && d < 6000) { return "rgb(33,113,181)"; }
	else if (d >= 6000 && d < 7000) { return "rgb(8,81,156)"; }
	else if (d >= 7000) { return "rgb(8,48,107)"; }
}

function onEachFeature(feature, layer) {
	layer.on({
		mousemove: mousemove,
		mouseout: mouseout
	});
}

var closeTooltip;

function mousemove(e) {
  var layer = e.target;
  var tract = layer.feature.properties.NAME10;
  var pop = rateById.get(tract);
  var pop_per_acre = popAcrebyID.get(tract);
  var housing_per_acre = housingAcrebyID.get(tract);

  popup.setLatLng(e.latlng);
  popup.setContent(
  	"<span style='font-weight:bold;font-size:13px'>Tract "+ tract +"</span><br>"
	+ "<span style='font-style:italic; color:grey;font-size:11px'>" 
		+ "Total population "+ pop +"</span><br>"
	+"<span style='font-size:11px'>Population per acre: " + pop_per_acre
		+"<br>Housing units per acre: " + housing_per_acre +"</span>"
  );


  if (!popup._map) popup.openOn(map);
  window.clearTimeout(closeTooltip);

  // highlight feature
  layer.setStyle({
      weight: 1,
      opacity: 1,
      fillOpacity: 0.9,
      color: "black"
  });

  if (!L.Browser.ie && !L.Browser.opera) {
      layer.bringToFront();
  }

  // link to viz
  svg_left.selectAll(".bar").each(function(d) {
		if(d.id ==  tract) {
			// console.log(tract+", "+d3.select(this).attr("height"));
			d3.select(this).attr("height", 8);
		}
	});

	svg_right.selectAll(".bar").each(function(d) {
		if(d.id ==  tract) {
			d3.select(this).attr("height", 8);
		}
	});
}


function mouseout(e) {
  total_population.resetStyle(e.target);
  closeTooltip = window.setTimeout(function() {
      map.closePopup();
  }, 100);

  // link to viz
  var layer = e.target;
  var tract = layer.feature.properties.NAME10;

  svg_left.selectAll(".bar").each(function(d) {
		if(d.id ==  tract) {
			d3.select(this).attr("height", 2);
		}
	});

	svg_right.selectAll(".bar").each(function(d) {
		if(d.id ==  tract) {
			d3.select(this).attr("height", 2);
		}
	});
}


function addAge() {
        //legend.addTo(this);
        $( "#viz_left" ).css( "visibility", "visible" );
        $( "#viz_right" ).css( "visibility", "visible" );
        $( "#des_age" ).css( "visibility" , "visible" );;	
}


function hideAge() {
// 		this.removeControl(legend);
		$( "#viz_left" ).css( "visibility", "hidden" );
		$( "#viz_right" ).css( "visibility", "hidden" );
		$( "#des_age" ).css( "visibility", "hidden" );	
}


// legend
//  map.legendControl.addLegend(getLegendHTML());

// function getLegendHTML() {
// var grades = [0, 10, 20, 50, 100, 200, 500, 1000],
// labels = [],
// from, to;

// for (var i = 0; i < grades.length; i++) {
//   from = grades[i];
//   to = grades[i + 1];

//   labels.push(
//     '<li><span class="swatch" style="background:' + getColor(from + 1) + '"></span> ' +
//     from + (to ? '&ndash;' + to : '+')) + '</li>';
// }

// return '<span>People per square mile</span><ul>' + labels.join('') + '</ul>';
// }


</script>

</script>


</body>
</html>